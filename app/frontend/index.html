<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TextArena VM Demo - Login</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      max-width: 600px;
      width: 100%;
    }
    h1 { 
      margin-top: 0; 
      color: #333;
      text-align: center;
    }
    label { 
      display: block; 
      margin-bottom: 8px; 
      color: #555;
      font-weight: 500;
    }
    input, button { 
      width: 100%; 
      padding: 12px; 
      margin-bottom: 16px; 
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    input {
      background: #fbfbff;
    }
    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      background: #ffffff;
    }
    button { 
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    button:hover {
      background: #5568d3;
    }
    .error { 
      color: #e74c3c; 
      margin-bottom: 12px;
      font-size: 14px;
    }
    .instance-selection {
      display: none;
    }
    .instance-btn {
      margin-bottom: 12px;
      background: #764ba2;
      text-align: left;
      padding: 16px;
    }
    .instance-btn:hover {
      background: #6a3f8f;
    }
    .instance-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .instance-modes {
      font-size: 14px;
      opacity: 0.9;
      line-height: 1.6;
    }
    .instance-mode-item {
      margin: 4px 0;
    }
    .user-mode-indicator {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    .instance-card {
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .instance-info {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
      padding: 15px;
      background: linear-gradient(135deg, #f8f9ff 0%, #f1f3ff 100%);
      border-radius: 8px;
      border: 1px solid #e1e6ff;
    }
    .instance-info img {
      width: 120px;
      height: 120px;
      object-fit: contain;
      border-radius: 8px;
      background: #ffffff;
      padding: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid #e1e6ff;
      flex-shrink: 0;
    }
    .instance-description {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .instance-description strong {
      font-size: 16px;
      font-weight: 700;
      color: #161937;
    }
    .instance-description-text {
      font-size: 14px;
      color: #5f6275;
      line-height: 1.5;
    }
    @media (max-width: 768px) {
      .instance-info {
        flex-direction: column;
        text-align: center;
      }
      .instance-info img {
        width: 100px;
        height: 100px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ® AI-Human Inventory Game</h1>

    <div id="login-section">
      <h2 style="text-align: center; color: #666; font-size: 18px;">Login</h2>
      <label>User ID <input id="user-id" type="text" placeholder="Enter your NetID (e.g., jb8340)" /></label>  
      <label>Name <input id="name" type="text" placeholder="Enter your name (e.g., JackieÂ Baek)" /></label>
      <button id="login-btn">Log In</button>
      <div id="login-error" class="error"></div>
    </div>

    <div id="instance-section" class="instance-selection">
      <h2 style="text-align: center; color: #666; font-size: 18px;">Select Instance</h2>
      <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 20px;">
        Choose which instance to play
      </p>
      
      <!-- Instance 0: Tutorial -->
      <div class="instance-card" style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
        <div class="instance-title" style="margin-bottom: 12px; color: #666; font-size: 18px;">Instance 0 (Tutorial Instance)</div>
        <div id="instance-0-info" class="instance-info" style="display: none;">
          <img id="instance-0-image" src="/instances/0/image" alt="Product image" style="display: none;" onerror="this.style.display='none';" onload="this.style.display='block'; document.getElementById('instance-0-info').style.display='flex';">
          <div id="instance-0-description" class="instance-description"></div>
        </div>
        <button class="instance-btn" onclick="selectTutorialMode('A')" style="margin-bottom: 8px;">
          <div class="instance-mode-item">ðŸ“Š Mode A: OR â†’ Human decisions</div>
        </button>
        <button class="instance-btn" onclick="selectTutorialMode('B')" style="margin-bottom: 8px;">
          <div class="instance-mode-item">ðŸŽ® Mode B: OR+LLM â†’ Human decisions</div>
        </button>
        <button class="instance-btn" onclick="selectTutorialMode('C')">
          <div class="instance-mode-item">ðŸ¤– Mode C: OR+LLM â†’ Human strategic guidance</div>
        </button>
      </div>

      <!-- Instance 1 -->
      <div class="instance-card" style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
        <div class="instance-title" style="margin-bottom: 12px; color: #666; font-size: 18px;">Instance 1</div>
        <div id="instance-1-info" class="instance-info" style="display: none;">
          <img id="instance-1-image" src="/instances/1/image" alt="Product image" style="display: none;" onerror="this.style.display='none';" onload="this.style.display='block'; document.getElementById('instance-1-info').style.display='flex';">
          <div id="instance-1-description" class="instance-description"></div>
        </div>
        <button class="instance-btn" id="instance-1-btn" onclick="selectInstance(1)">
          <div class="instance-modes" id="instance-1-modes">
            <!-- Will be populated by JavaScript -->
          </div>
        </button>
      </div>

      <!-- Instance 2 -->
      <div class="instance-card" style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
        <div class="instance-title" style="margin-bottom: 12px; color: #666; font-size: 18px;">Instance 2</div>
        <div id="instance-2-info" class="instance-info" style="display: none;">
          <img id="instance-2-image" src="/instances/2/image" alt="Product image" style="display: none;" onerror="this.style.display='none';" onload="this.style.display='block'; document.getElementById('instance-2-info').style.display='flex';">
          <div id="instance-2-description" class="instance-description"></div>
        </div>
        <button class="instance-btn" id="instance-2-btn" onclick="selectInstance(2)">
          <div class="instance-modes" id="instance-2-modes">
            <!-- Will be populated by JavaScript -->
          </div>
        </button>
      </div>

      <!-- Instance 3 -->
      <div class="instance-card" style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
        <div class="instance-title" style="margin-bottom: 12px; color: #666; font-size: 18px;">Instance 3</div>
        <div id="instance-3-info" class="instance-info" style="display: none;">
          <img id="instance-3-image" src="/instances/3/image" alt="Product image" style="display: none;" onerror="this.style.display='none';" onload="this.style.display='block'; document.getElementById('instance-3-info').style.display='flex';">
          <div id="instance-3-description" class="instance-description"></div>
        </div>
        <button class="instance-btn" id="instance-3-btn" onclick="selectInstance(3)">
          <div class="instance-modes" id="instance-3-modes">
            <!-- Will be populated by JavaScript -->
          </div>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Group assignments: [user_index_1_mode, user_index_2_mode, user_index_3_mode]
    const GROUPS = [
      ['A', 'B', 'C'], // Group 1: 1-A, 2-B, 3-C
      ['A', 'C', 'B'], // Group 2: 1-A, 2-C, 3-B
      ['B', 'A', 'C'], // Group 3: 1-B, 2-A, 3-C
      ['B', 'C', 'A'], // Group 4: 1-B, 2-C, 3-A
      ['C', 'A', 'B'], // Group 5: 1-C, 2-A, 3-B
      ['C', 'B', 'A'], // Group 6: 1-C, 2-B, 3-A
    ];

    // Mode descriptions
    const MODE_DESCRIPTIONS = {
      'A': 'ðŸ“Š Mode A: OR â†’ Human decisions',
      'B': 'ðŸŽ® Mode B: OR+LLM â†’ Human decisions',
      'C': 'ðŸ¤– Mode C: OR+LLM â†’ Human strategic guidance'
    };

    // Check if user is already logged in
    const storedUserId = localStorage.getItem('user_id');
    const storedName = localStorage.getItem('user_name');
    const storedUserIndex = localStorage.getItem('user_index');
    
    const loginSection = document.getElementById("login-section");
    const instanceSection = document.getElementById("instance-section");
    const loginError = document.getElementById("login-error");

    if (storedUserId && storedName) {
      // User is already logged in, show instance selection
      loginSection.style.display = "none";
      instanceSection.style.display = "block";
      
      // Load images and descriptions for all instances
      loadInstanceInfo();
      
      // Populate instance modes if user_index is available
      if (storedUserIndex) {
        populateInstanceModes(parseInt(storedUserIndex));
      }
    }

    async function loadInstanceInfo() {
      // Load images and descriptions for instances 0-3
      for (let instanceNum = 0; instanceNum <= 3; instanceNum++) {
        try {
          const infoEl = document.getElementById(`instance-${instanceNum}-info`);
          const descEl = document.getElementById(`instance-${instanceNum}-description`);
          const imgEl = document.getElementById(`instance-${instanceNum}-image`);
          
          // Load description
          const descResponse = await fetch(`/instances/${instanceNum}/description`);
          if (descResponse.ok) {
            const descData = await descResponse.json();
            if (descEl) {
              let descHTML = "";
              if (descData.product) {
                descHTML += `<strong>${descData.product}</strong>`;
              }
              if (descData.description) {
                descHTML += `<div class="instance-description-text">${descData.description}</div>`;
              }
              descEl.innerHTML = descHTML || "";
              
              // Show info section if we have at least description
              if (descHTML && infoEl) {
                infoEl.style.display = "flex";
              }
            }
          }
          
          // Load image
          if (imgEl) {
            imgEl.onload = function() {
              this.style.display = "block";
              if (infoEl) {
                infoEl.style.display = "flex";
              }
            };
            imgEl.onerror = function() {
              this.style.display = "none";
            };
            // Try to load image
            imgEl.src = `/instances/${instanceNum}/image?t=${Date.now()}`;
          }
        } catch (err) {
          console.error(`Error loading info for instance ${instanceNum}:`, err);
        }
      }
    }

    function getGroupForUserIndex(userIndex) {
      // Determine which group this user belongs to (0-5)
      // Groups cycle every 6 users
      return (userIndex - 1) % 6;
    }

    function populateInstanceModes(userIndex) {
      const group = getGroupForUserIndex(userIndex);
      const groupAssignment = GROUPS[group];
      
      // Populate instances 1-3
      for (let instanceNum = 1; instanceNum <= 3; instanceNum++) {
        const modesDiv = document.getElementById(`instance-${instanceNum}-modes`);
        const btn = document.getElementById(`instance-${instanceNum}-btn`);
        
        if (modesDiv && btn) {
          // Each group array represents [instance_1_mode, instance_2_mode, instance_3_mode]
          // So for each instance, use the corresponding position in the group array
          const mode = groupAssignment[instanceNum - 1]; // instance 1 -> index 0, instance 2 -> index 1, instance 3 -> index 2
          const modeText = MODE_DESCRIPTIONS[mode] || 'Unknown mode';
          
          // Display mode in the same style as Instance 0 buttons
          modesDiv.innerHTML = `<div class="instance-mode-item">${modeText}</div>`;
          
          // Highlight the button if this is the user's assigned instance
          if (instanceNum === userIndex) {
            btn.style.border = '2px solid #667eea';
          }
        }
      }
    }

    document.getElementById("login-btn").addEventListener("click", async () => {
      loginError.textContent = "";
      const userIdInput = document.getElementById("user-id");
      const nameInput = document.getElementById("name");
      const userId = userIdInput.value.trim();
      const name = nameInput.value.trim();
      
      if (!userId || !name) {
        loginError.textContent = "User ID and name are required";
        return;
      }

      try {
        // Ask backend to hash (user_id + name) and create/fetch index in Supabase
        const resp = await fetch("/user-index", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ user_id: userId, name }),
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || "Failed to register user");
        }

        const data = await resp.json();

        // Persist identifiers locally
        localStorage.setItem("user_id", userId);
        localStorage.setItem("user_name", name);
        if (data && typeof data.index === "number") {
          localStorage.setItem("user_index", String(data.index));
        }
        if (data && typeof data.uuid === "string") {
          localStorage.setItem("user_uuid", data.uuid);
        }

        // Show instance selection
        loginSection.style.display = "none";
        instanceSection.style.display = "block";
        
        // Populate instance modes based on user_index
        if (data && typeof data.index === "number") {
          populateInstanceModes(data.index);
        }
      } catch (err) {
        console.error(err);
        loginError.textContent = err.message || "Login failed. Please try again.";
      }
    });

    function selectTutorialMode(mode) {
      // Map mode to page for tutorial instance
      let targetPage = '';
      if (mode === 'A') {
        targetPage = '/modeA.html';
      } else if (mode === 'B') {
        targetPage = '/modeB.html';
      } else if (mode === 'C') {
        targetPage = '/modeC.html';
      }
      
      if (targetPage) {
        window.location.href = `${targetPage}?instance=0`;
      } else {
        alert('Error: Unknown mode');
      }
    }

    function selectInstance(instanceNum) {
      const userIndex = parseInt(localStorage.getItem('user_index'));
      
      if (!userIndex || instanceNum < 1 || instanceNum > 3) {
        alert('Invalid instance selection');
        return;
      }
      
      // Determine which mode to use based on the instance number and user's group
      // Each group array represents [instance_1_mode, instance_2_mode, instance_3_mode]
      const group = getGroupForUserIndex(userIndex);
      const groupAssignment = GROUPS[group];
      // Use the instance number to determine which mode from the group array
      const mode = groupAssignment[instanceNum - 1]; // instance 1 -> index 0, instance 2 -> index 1, instance 3 -> index 2
      
      // Map mode to page (using new mode pages)
      let targetPage = '';
      if (mode === 'A') {
        targetPage = '/modeA.html';
      } else if (mode === 'B') {
        targetPage = '/modeB.html';
      } else if (mode === 'C') {
        targetPage = '/modeC.html';
      }
      
      if (targetPage) {
        window.location.href = `${targetPage}?instance=${instanceNum}`;
      } else {
        alert('Error: Unknown mode assignment');
      }
    }
  </script>
</body>
</html>
